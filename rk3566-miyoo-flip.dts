// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright (c) 2020 Rockchip Electronics Co., Ltd.
 * Miyoo Flip (codename miyoo-355) - Mainline Linux device tree
 */
/dts-v1/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/rockchip.h>
#include <dt-bindings/pwm/pwm.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include <dt-bindings/soc/rockchip,vop2.h>
#include "rk3566.dtsi"

/ {
	model = "Miyoo Flip";
	compatible = "miyoo,flip", "rockchip,rk3566";

	chosen: chosen {
		bootargs = "earlycon=uart8250,mmio32,0xfe660000 console=ttyS2,1500000n8 root=/dev/mtdblock3 rootfstype=squashfs rootwait fw_devlink=permissive";
		stdout-path = "serial2:1500000n8";
	};

	/* adc-keys DISABLED: volume buttons are on GPIO, not ADC.
	 * The adc-keys driver polls saradc ch0 which is floating on Miyoo Flip,
	 * causing phantom KEY_VOLUMEDOWN and triggering recovery_mode in init. */
	adc_keys: adc-keys {
		compatible = "adc-keys";
		io-channels = <&saradc 0>;
		io-channel-names = "buttons";
		keyup-threshold-microvolt = <1800000>;
		poll-interval = <100>;
		status = "disabled";

		vol-up-key {
			label = "volume up";
			linux,code = <KEY_VOLUMEUP>;
			press-threshold-microvolt = <1750>;
		};

		vol-down-key {
			label = "volume down";
			linux,code = <KEY_VOLUMEDOWN>;
			press-threshold-microvolt = <297500>;
		};
	};

	gpio-keys {
		compatible = "gpio-keys";
		autorepeat;
		b-button {
				label = "b";
				linux,code = <KEY_LEFTCTRL>;
				gpios = <&gpio3 RK_PC2 GPIO_ACTIVE_LOW>;
		};
		y-button {
				label = "y";
				linux,code = <KEY_LEFTALT>;
				gpios = <&gpio3 RK_PC0 GPIO_ACTIVE_LOW>;
		};
		select-button {
				label = "select";
				linux,code = <KEY_RIGHTCTRL>;
				gpios = <&gpio3 RK_PB6 GPIO_ACTIVE_LOW>;
		};
		start-button {
				label = "start";
				linux,code = <KEY_ENTER>;
				gpios = <&gpio3 RK_PB5 GPIO_ACTIVE_LOW>;
		};
		up-button {
				label = "up";
				linux,code = <KEY_UP>;
				gpios = <&gpio3 RK_PA3 GPIO_ACTIVE_LOW>;
		};
		down-button {
				label = "down";
				linux,code = <KEY_DOWN>;
				gpios = <&gpio3 RK_PA4 GPIO_ACTIVE_LOW>;
		};
		left-button {
				label = "left";
				linux,code = <KEY_LEFT>;
				gpios = <&gpio3 RK_PA5 GPIO_ACTIVE_LOW>;
		};
		right-button {
				label = "right";
				linux,code = <KEY_RIGHT>;
				gpios = <&gpio3 RK_PA6 GPIO_ACTIVE_LOW>;
		};
		a-button {
				label = "a";
				linux,code = <KEY_SPACE>;
				gpios = <&gpio3 RK_PC3 GPIO_ACTIVE_LOW>;
		};
		x-button {
				label = "x";
				linux,code = <KEY_LEFTSHIFT>;
				gpios = <&gpio3 RK_PC1 GPIO_ACTIVE_LOW>;
		};
		l1-button {
				label = "l1";
				linux,code = <KEY_TAB>;
				gpios = <&gpio3 RK_PB1 GPIO_ACTIVE_LOW>;
		};
		r1-button {
				label = "r1";
				linux,code = <KEY_BACKSPACE>;
				gpios = <&gpio3 RK_PB3 GPIO_ACTIVE_LOW>;
		};
		l2-button {
				label = "l2";
				linux,code = <KEY_PAGEUP>;
				gpios = <&gpio3 RK_PB2 GPIO_ACTIVE_LOW>;
		};
		r2-button {
				label = "r2";
				linux,code = <KEY_PAGEDOWN>;
				gpios = <&gpio3 RK_PB4 GPIO_ACTIVE_LOW>;
		};
		l3-button {
				label = "l3";
				linux,code = <KEY_RIGHTALT>;
				gpios = <&gpio2 RK_PC1 GPIO_ACTIVE_HIGH>;
		};
		r3-button {
				label = "r3";
				linux,code = <KEY_RIGHTSHIFT>;
				gpios = <&gpio2 RK_PC0 GPIO_ACTIVE_HIGH>;
		};
		mode-button {
				label = "menu";
				linux,code = <KEY_ESC>;
				gpios = <&gpio3 RK_PA1 GPIO_ACTIVE_LOW>;
		};
		vol-up-button {
				label = "vol up";
				linux,code = <KEY_VOLUMEUP>;
				gpios = <&gpio3 RK_PA7 GPIO_ACTIVE_LOW>;
		};
		vol-down-button {
				label = "vol down";
				linux,code = <KEY_VOLUMEDOWN>;
				gpios = <&gpio3 RK_PB0 GPIO_ACTIVE_LOW>;
		};
	};

	backlight: backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm4 0 1250000 0>;
		brightness-levels = <
			  0  20  20  21  21  22  22  23
			 23  24  24  25  25  26  26  27
			 27  28  28  29  29  30  30  31
			 31  32  32  33  33  34  34  35
			 35  36  36  37  37  38  38  39
			 40  41  42  43  44  45  46  47
			 48  49  50  51  52  53  54  55
			 56  57  58  59  60  61  62  63
			 64  65  66  67  68  69  70  71
			 72  73  74  75  76  77  78  79
			 80  81  82  83  84  85  86  87
			 88  89  90  91  92  93  94  95
			 96  97  98  99 100 101 102 103
			104 105 106 107 108 109 110 111
			112 113 114 115 116 117 118 119
			120 121 122 123 124 125 126 127
			128 129 130 131 132 133 134 135
			136 137 138 139 140 141 142 143
			144 145 146 147 148 149 150 151
			152 153 154 155 156 157 158 159
			160 161 162 163 164 165 166 167
			168 169 170 171 172 173 174 175
			176 177 178 179 180 181 182 183
			184 185 186 187 188 189 190 191
			192 193 194 195 196 197 198 199
			200 201 202 203 204 205 206 207
			208 209 210 211 212 213 214 215
			216 217 218 219 220 221 222 223
			224 225 226 227 228 229 230 231
			232 233 234 235 236 237 238 239
			240 241 242 243 244 245 246 247
			248 249 250 251 252 253 254 255
		>;
		default-brightness-level = <200>;
	};

	/* WiFi/BT power control: RTL8733BU combo chip, USB-attached.
	 * regulator-always-on is REQUIRED: without it, the regulator framework
	 * disables the regulator at ~33s (no DTS consumer holds it), the WiFi
	 * USB device disconnects, and the 8733bu driver enters a broken Runtime
	 * PM state that deadlocks the suspend path.
	 * The driver has rtw_suspend()/rtw_resume() USB callbacks that handle
	 * system suspend properly when the chip remains powered. */
	vcc_wifi: vcc-wifi {
		compatible = "regulator-fixed";
		regulator-name = "vcc_wifi";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		enable-active-low;
		gpio = <&gpio0 RK_PA0 GPIO_ACTIVE_LOW>;
		pinctrl-names = "default";
		pinctrl-0 = <&wifi_enable_h>;
		regulator-boot-on;
		regulator-always-on;
	};

	/* Speaker amplifier enable: GPIO4_PC2 (same pin as BSP spk-ctl-gpios).
	 * In mainline, use simple-audio-amplifier + aux-devs instead of BSP codec driver GPIO.
	 * VCC-supply powers the amp; vccio_acodec (3.3V) is the audio codec IO supply. */
	spk_amp: audio-amplifier {
		compatible = "simple-audio-amplifier";
		VCC-supply = <&vccio_acodec>;
		enable-gpios = <&gpio4 RK_PC2 GPIO_ACTIVE_HIGH>;
		pinctrl-names = "default";
		pinctrl-0 = <&spk_amp_enable_h>;
		sound-name-prefix = "Speaker Amp";
	};

	rk817-sound {
		status = "okay";
		compatible = "simple-audio-card";
		simple-audio-card,name = "rockchip-rk817";
		simple-audio-card,aux-devs = <&spk_amp>;
		simple-audio-card,format = "i2s";
		simple-audio-card,mclk-fs = <256>;
		simple-audio-card,widgets =
			"Headphone", "Headphones",
			"Speaker", "Speaker";
		simple-audio-card,routing =
			"Headphones", "HPOL",
			"Headphones", "HPOR",
			"Speaker Amp INL", "SPKO",
			"Speaker Amp INR", "SPKO",
			"Speaker", "Speaker Amp OUTL",
			"Speaker", "Speaker Amp OUTR";

		simple-audio-card,cpu {
			sound-dai = <&i2s1_8ch>;
		};
		simple-audio-card,codec {
			sound-dai = <&rk817>;
		};
	};

	battery: battery {
		compatible = "simple-battery";
		charge-full-design-microamp-hours = <3000000>;
		charge-term-current-microamp = <300000>;
		constant-charge-current-max-microamp = <2000000>;
		constant-charge-voltage-max-microvolt = <4300000>;
		factory-internal-resistance-micro-ohms = <117000>;
		voltage-max-design-microvolt = <4227000>;
		voltage-min-design-microvolt = <3400000>;

		ocv-capacity-celsius = <20>;
		ocv-capacity-table-0 =  <4227000 100>, <4186000 95>, <3970000 90>, <3920000 85>,
					<3873000 80>, <3836000 75>, <3790000 70>, <3759000 65>,
					<3727000 60>, <3685000 55>, <3655000 50>, <3622000 45>,
					<3585000 40>, <3566000 35>, <3540000 30>, <3516000 25>,
					<3495000 20>, <3470000 15>, <3450000 10>, <3420000 5>,
					<3400000 0>;
	};

	hall_sensor: hall-mh248 {
		compatible = "hall-mh248";
		irq-gpio = <&gpio0 RK_PC6 IRQ_TYPE_EDGE_BOTH>;
		hall-active = <1>;
		wakeup-source;
	};

	leds: leds {
		compatible = "gpio-leds";
		work_led: work {
			gpios = <&gpio0 RK_PB4 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "default-on";
		};
		charger_led: charger {
			gpios = <&gpio0 RK_PC2 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "battery-charging";
			retain-state-suspended;
		};
	};

	vccsys: vccsys {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v8_sys";
		regulator-always-on;
		regulator-boot-on;
		regulator-min-microvolt = <3800000>;
		regulator-max-microvolt = <3800000>;
	};

	/* vcc5v0_usb: removed — was an intermediate always-on 5V regulator
	 * between dcdc_boost and vcc5v0_host. Unnecessary on this board;
	 * vcc5v0_host now sources directly from dcdc_boost. */

	/* USB host 5V power: GPIO-controlled via GPIO4_PC5.
	 * Removed always-on/boot-on so this rail powers off during suspend.
	 * vin-supply changed from vcc5v0_usb to dcdc_boost (direct path). */
	vcc5v0_host: vcc5v0-host-regulator {
		compatible = "regulator-fixed";
		regulator-name = "vcc5v0_host";
		enable-active-high;
		gpio = <&gpio4 RK_PC5 GPIO_ACTIVE_HIGH>;	/*USB_HOST_PWREN2_H*/
		vin-supply = <&dcdc_boost>;
		pinctrl-names = "default";
		pinctrl-0 = <&vcc5v0_host_en>;
		regulator-state-mem {
			regulator-off-in-suspend;
		};
	};
	
	/* LCD panel 3.3V power: GPIO-controlled via GPIO0_PC7.
	 * The panel driver requests this regulator on demand via iovcc/vdd supply.
	 * Not always-on so it powers off during suspend. */
	vcc3v3_lcd0_n: vcc3v3-lcd0-n {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v3_lcd0_n";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		enable-active-high;
		gpio = <&gpio0 RK_PC7 GPIO_ACTIVE_HIGH>;	/*LCD_PWREN_H*/
		vin-supply = <&vcc_3v3>;

		regulator-state-mem {
			regulator-off-in-suspend;
		};
	};
	
	vcc_sd: vcc-sd {
		compatible = "regulator-fixed";
		enable-active-low;
		enable-gpios = <&gpio0 RK_PA5 GPIO_ACTIVE_LOW>;	/*SDMMC_PWREN_L*/
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		pinctrl-names = "default";
		pinctrl-0 = <&vcc_sd_h>;
		regulator-name = "vcc_sd";
	};
	
	vcc_sd2: vcc-sd2 {
		compatible = "regulator-fixed";
		enable-active-low;
		enable-gpios = <&gpio2 RK_PB1 GPIO_ACTIVE_LOW>;	/*SDMMC1_PWREN_L*/
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		pinctrl-names = "default";
		pinctrl-0 = <&vcc_sd2_h>;
		regulator-name = "vcc_sd2";
	};

	/* test-power: stock BSP node for factory testing. Harmless to keep. */
	test-power {
		status = "okay";
	};

	/* DMC + DFI: DDR Memory Controller devfreq + DDR bandwidth monitor.
	 * CONFIG_ARM_RK3568_DMC_DEVFREQ is not available for RK3566 yet.
	 * Without the DMC driver, this node is never probed. Keeping it here
	 * (disabled) for future mainline DMC support on RK3566.
	 * When DMC was "okay" it held a reference on vdd_logic, preventing
	 * it from powering off during suspend. */
	/*
	dmc: dmc {
		compatible = "rockchip,rk3568-dmc";
		devfreq-events = <&dfi>;
		center-supply = <&vdd_logic>;
		operating-points-v2 = <&dmc_opp_table>;
		status = "okay";
	};

	dmc_opp_table: dmc-opp-table {
		compatible = "operating-points-v2";

		opp-324000000 {
			opp-hz = /bits/ 64 <324000000>;
			opp-microvolt = <900000>;
		};
		opp-528000000 {
			opp-hz = /bits/ 64 <528000000>;
			opp-microvolt = <900000>;
		};
		opp-780000000 {
			opp-hz = /bits/ 64 <780000000>;
			opp-microvolt = <900000>;
		};
		opp-1056000000 {
			opp-hz = /bits/ 64 <1056000000>;
			opp-microvolt = <900000>;
		};
	};
	*/
};

/* Display pipeline: VP1 -> DSI0 -> panel (MIPI DSI).
 * DPHY0 is required for the DSI link; DPHY1 is unused. */
&dsi_dphy0 {
	status = "okay";
};

&dsi_dphy1 {
	status = "disabled";
};

&vp1 {
	vp1_out_dsi0: endpoint@ROCKCHIP_VOP2_EP_MIPI0 {
		reg = <ROCKCHIP_VOP2_EP_MIPI0>;
		remote-endpoint = <&dsi0_in_vp1>;
	};
};

/* VOP2 -> HDMI pipeline: use VP0 (standard for RK356x).
 * Without this, dw_hdmi_rockchip_bind() returns -EPROBE_DEFER
 * (possible_crtcs == 0) which blocks the entire display-subsystem master. */
&hdmi_in {
	hdmi_in_vp0: endpoint {
		remote-endpoint = <&vp0_out_hdmi>;
	};
};

&vp0 {
	vp0_out_hdmi: endpoint@ROCKCHIP_VOP2_EP_HDMI0 {
		reg = <ROCKCHIP_VOP2_EP_HDMI0>;
		remote-endpoint = <&hdmi_in_vp0>;
	};
};

/* DFI: DDR bandwidth monitor (devfreq-event source for DMC).
 * CONFIG_DEVFREQ_EVENT_ROCKCHIP_DFI=y is set in kernel config but
 * without DMC there is no consumer. Disabled to avoid an orphan
 * devfreq-event device. Re-enable together with DMC when mainline
 * RK3566 DMC support is added. */
/*
&dfi {
	status = "okay";
};
*/

&cpu0 {
	cpu-supply = <&vdd_cpu_rk860>;
	status = "okay";
};

&dsi0 {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	ports {
		dsi0_in: port@0 {
			reg = <0>;
			dsi0_in_vp1: endpoint {
				remote-endpoint = <&vp1_out_dsi0>;
			};
		};

		dsi0_out: port@1 {
			reg = <1>;
			mipi_out_panel: endpoint {
				remote-endpoint = <&mipi_in_panel>;
			};
		};
	};

	/* Panel init sequence and timings are in the miyoo,flip-panel
	 * entry in panel-simple.c (kernel patch). */
	panel@0 {
		compatible = "miyoo,flip-panel";
		reg = <0>;
		power-supply = <&vcc3v3_lcd0_n>;
		backlight = <&backlight>;

		port {
			mipi_in_panel: endpoint {
				remote-endpoint = <&mipi_out_panel>;
			};
		};
	};
};

/* GPU: Mali G52 (Panfrost/kbase). mali-supply is the GPU voltage rail. */

&gpu {
	mali-supply = <&vdd_gpu>;
	status = "okay";
};

&hdmi {
	status = "okay";
	avdd-0v9-supply = <&vdda_0v9>;
	avdd-1v8-supply = <&vcc_1v8>;
	rockchip,phy-table =
		<92812500  0x8009 0x0000 0x0270>,
		<165000000 0x800b 0x0000 0x026d>,
		<185625000 0x800b 0x0000 0x01ed>,
		<297000000 0x800b 0x0000 0x01ad>,
		<594000000 0x8029 0x0000 0x0088>,
		<000000000 0x0000 0x0000 0x0000>;
};

&hdmi_sound {
	status = "okay";
};


&i2c0 {
	status = "okay";

	/* TCS4525 at 0x1c: not populated on this board revision.
	 * The Miyoo Flip V10 uses an RK8600 at 0x40 for the CPU rail.
	 * Disabled to silence "fan53555-regulator 0-001c: Failed to get chip ID" error. */
	vdd_cpu: tcs4525@1c {
		compatible = "tcs,tcs4525";
		reg = <0x1c>;
		status = "disabled";
	};

    /* CPU rail: fan53555 driver probes this (RK8600 shares code). Must set fcs,suspend-voltage-selector
     * so driver uses correct VSEL; wrong value can drop CPU rail and hang right after "FAN53555 Detected!".
     * See deep-research-report.md. */
    vdd_cpu_rk860: rk8600@40{
        compatible = "rockchip,rk8600";
        reg = <0x40>;
        vin-supply = <&vccsys>;
        regulator-compatible = "rk860x-reg";
        regulator-name = "vdd_cpu";
        regulator-min-microvolt = <712500>;
        regulator-max-microvolt = <1390000>;
        regulator-init-microvolt = <900000>;
        regulator-ramp-delay = <2300>;
        fcs,suspend-voltage-selector = <1>;  /* driver only reads this property name; <1> = safe for RK3566 */
        regulator-boot-on;
        regulator-always-on;
        regulator-state-mem {
            regulator-off-in-suspend;
        };
    };

	rk817: pmic@20 {
		status = "okay";
		compatible = "rockchip,rk817";
		reg = <0x20>;
		interrupt-parent = <&gpio0>;
		interrupts = <3 IRQ_TYPE_LEVEL_LOW>;

		pinctrl-names = "default";
		pinctrl-0 = <&pmic_int>, <&i2s1m0_mclk>;
		system-power-controller;
		wakeup-source;
		#clock-cells = <1>;
		#sound-dai-cells = <0>;
		clock-output-names = "rk808-clkout1", "rk808-clkout2";
		clock-names = "mclk";
		clocks = <&cru I2S1_MCLKOUT_TX>;
		assigned-clocks = <&cru I2S1_MCLKOUT_TX>;
		assigned-clock-parents = <&cru CLK_I2S1_8CH_TX>;
		assigned-clock-rates = <12288000>;

		vcc1-supply = <&vccsys>;
		vcc2-supply = <&vccsys>;
		vcc3-supply = <&vccsys>;
		vcc4-supply = <&vccsys>;
		vcc5-supply = <&vccsys>;
		vcc6-supply = <&vccsys>;
		vcc7-supply = <&vccsys>;
		vcc8-supply = <&vccsys>;
		/* vcc9 = vccsys to avoid fw_devlink cycle: pmic -> BOOST -> pmic (mainline 6.6+) */
		vcc9-supply = <&vccsys>;

		pwrkey {
			status = "okay";
		};

		regulators {
			vdd_logic: DCDC_REG1 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <500000>;
				regulator-max-microvolt = <1350000>;
				regulator-init-microvolt = <900000>;
				regulator-ramp-delay = <6001>;
				regulator-initial-mode = <0x2>;
				regulator-name = "vdd_logic";
				/* off-in-suspend: TF-A handles vdd_logic power
				 * sequencing during deep sleep entry/exit. */
				regulator-state-mem {
					regulator-off-in-suspend;
					regulator-suspend-microvolt = <900000>;
				};
			};

			vdd_gpu: DCDC_REG2 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <500000>;
				regulator-max-microvolt = <1350000>;
				regulator-init-microvolt = <900000>;
				regulator-ramp-delay = <6001>;
				regulator-initial-mode = <0x2>;
				regulator-name = "vdd_gpu";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc_ddr: DCDC_REG3 {
				regulator-always-on;
				regulator-boot-on;
				regulator-initial-mode = <0x2>;
				regulator-name = "vcc_ddr";
				regulator-state-mem {
					regulator-on-in-suspend;
				};
			};

			vcc_3v3: DCDC_REG4 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-initial-mode = <0x2>;
				regulator-name = "vcc_3v3";
				/* off-in-suspend: powers off the main 3.3V rail during
				 * deep sleep for maximum battery savings. Confirmed
				 * working — TF-A restores the rail on resume. */
				regulator-state-mem {
					regulator-off-in-suspend;
					regulator-suspend-microvolt = <3300000>;
				};
			};

			vcca1v8_pmu: LDO_REG1 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-name = "vcca1v8_pmu";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1800000>;
				};
			};

			vdda_0v9: LDO_REG2 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <900000>;
				regulator-max-microvolt = <900000>;
				regulator-name = "vdda_0v9";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vdda0v9_pmu: LDO_REG3 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <900000>;
				regulator-max-microvolt = <900000>;
				regulator-name = "vdda0v9_pmu";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <900000>;
				};
			};

			vccio_acodec: LDO_REG4 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-name = "vccio_acodec";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vccio_sd: LDO_REG5 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <3300000>;
				regulator-name = "vccio_sd";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc3v3_pmu: LDO_REG6 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-name = "vcc3v3_pmu";
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3300000>;
				};
			};

			vcc_1v8: LDO_REG7 {
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-name = "vcc_1v8";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc1v8_dvp: LDO_REG8 {
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-name = "vcc1v8_dvp";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc2v8_dvp: LDO_REG9 {
				regulator-min-microvolt = <2800000>;
				regulator-max-microvolt = <2800000>;
				regulator-name = "vcc2v8_dvp";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			dcdc_boost: BOOST {
				/* Not always-on: BOOST (5V step-up for USB host power)
				 * must be allowed to power off during suspend. */
				regulator-min-microvolt = <5000000>;
				regulator-max-microvolt = <5000000>;
				regulator-name = "boost";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			otg_switch: OTG_SWITCH {
				regulator-name = "otg_switch";
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};
		};

		rk817_charger: charger {
			monitored-battery = <&battery>;
			rockchip,resistor-sense-micro-ohms = <10000>;
			rockchip,sleep-enter-current-microamp = <150000>;
			rockchip,sleep-filter-current-microamp = <100000>;
		};

		/*
		 * Mainline rk817-codec driver reads DT properties from
		 * of_get_child_by_name(dev->parent->of_node, "codec").
		 * No compatible needed; MFD cell matches by platform name.
		 * Clocks/pinctrl come from the PMIC parent node above.
		 */
		codec {
		};
	};
};

/* MUIC (Micro USB Interface Controller) — proprietary "gi,muic" chip for
 * USB cable-type detection (charger vs data vs OTG).  No mainline driver.
 * Basic charge/USB detection works through USB PHY extcon (usb2phy0)
 * without this, so keep i2c3 disabled. */
&i2c3 {
	status = "disabled";
};

&i2s0_8ch {
	status = "okay";
};

&i2s1_8ch {
	status = "okay";
	/* BSP used rockchip,clk-trcm = <1>; mainline property name is different */
	rockchip,trcm-sync-tx-only;
	pinctrl-names = "default";
	pinctrl-0 = <&i2s1m0_sclktx
		     &i2s1m0_lrcktx
		     &i2s1m0_sdi0
		     &i2s1m0_sdo0>;
};

/* IEP (Image Enhancement Processor): hardware deinterlacer/scaler at 0xfdef0000.
 * The BSP uses "rockchip,iep-v2" which requires the proprietary MPP (Media Process
 * Platform) framework — a large set of BSP-only drivers (mpp_service, mpp_dev, etc.)
 * that have no mainline equivalent and cannot be ported as a simple out-of-tree module.
 * IEP shares PD_RGA power domain with RGA (which IS probed), so its power domain
 * is already managed — no battery penalty from leaving it disabled.
 * For retro gaming, IEP's deinterlacing is rarely useful (emulators output progressive).
 *
 * jpegd, jpegd_mmu, mpp_srv, nandc0: also BSP-only, not in mainline rk356x. */

 /*
  * There are 10 independent IO domains in RK3566/RK3568, including PMUIO[0:2] and VCCIO[1:7].
  * 1/ PMUIO0 and PMUIO1 are fixed-level power domains which cannot be configured;
  * 2/ PMUIO2 and VCCIO1,VCCIO[3:7] domains require that their hardware power supply voltages
  *    must be consistent with the software configuration correspondingly
  *	a/ When the hardware IO level is connected to 1.8V, the software voltage configuration
  *	   should also be configured to 1.8V accordingly;
  *	b/ When the hardware IO level is connected to 3.3V, the software voltage configuration
  *	   should also be configured to 3.3V accordingly;
  * 3/ VCCIO2 voltage control selection (0xFDC20140)
  *	BIT[0]: 0x0: from GPIO_0A7 (default)
  *	BIT[0]: 0x1: from GRF
  *    Default is determined by Pin FLASH_VOL_SEL/GPIO0_A7:
  *	L:VCCIO2 must supply 3.3V
  *	H:VCCIO2 must supply 1.8V
  */
&pmu_io_domains {
	status = "okay";
	pmuio2-supply = <&vcc3v3_pmu>;
	vccio1-supply = <&vccio_acodec>;
	vccio3-supply = <&vccio_sd>;
	vccio4-supply = <&vcc_3v3>;
	vccio5-supply = <&vcc_1v8>;
	vccio6-supply = <&vcc_1v8>;
	vccio7-supply = <&vcc_3v3>;
};

&pwm4 {
	status = "okay";
};

/* SARADC: vref-supply sets the ADC reference voltage. */

&saradc {
	status = "okay";
	vref-supply = <&vcc_1v8>;
};

/* sdhci (fc000000): eMMC controller — disabled.
 * The Miyoo Flip has no eMMC; internal storage is SPI-NAND (via SFC).
 * The two SD card slots use sdmmc0 and sdmmc1. */
&sdhci {
	status = "disabled";
};

&sdmmc0 {
	max-frequency = <150000000>;
	no-sdio;
	no-mmc;
	bus-width = <4>;
	cap-mmc-highspeed;
	cap-sd-highspeed;
	disable-wp;
	sd-uhs-sdr104;
	vmmc-supply = <&vcc_sd>;
	vqmmc-supply = <&vccio_sd>;
	pinctrl-names = "default";
	pinctrl-0 = <&sdmmc0_bus4 &sdmmc0_clk &sdmmc0_cmd &sdmmc0_det>;
	status = "okay";
};

&sdmmc1 {
	max-frequency = <150000000>;
	no-sdio;
	no-mmc;
	bus-width = <4>;
	cap-mmc-highspeed;
	cap-sd-highspeed;
	disable-wp;
	sd-uhs-sdr104;
	vmmc-supply = <&vcc_sd2>;
	vqmmc-supply = <&vccio_sd>;
	pinctrl-names = "default";
	pinctrl-0 = <&sdmmc1_bus4 &sdmmc1_clk &sdmmc1_cmd &sdmmc1_det>;
	status = "okay";
};

&sfc {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	flash@0 {
		compatible = "spi-nand";
		reg = <0>;
		/* Lower 24 MHz + single-line RX: avoid wrong ID read at 50MHz/quad.
		 * Chip is ESMT (0xc8). */
		spi-max-frequency = <24000000>;
		spi-rx-bus-width = <1>;
		spi-tx-bus-width = <1>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@200000 {
				label = "vnvm";
				reg = <0x200000 0x100000>;
			};
			partition@300000 {
				label = "uboot";
				reg = <0x300000 0x400000>;
			};
			partition@700000 {
				label = "boot";
				reg = <0x700000 0x2600000>;
			};
			partition@2d00000 {
				label = "rootfs";
				reg = <0x2d00000 0x4000000>;
			};
			partition@6d00000 {
				label = "userdata";
				reg = <0x6d00000 0x1260000>;
			};
		};
	};
};

&tsadc {
	status = "okay";
	/* CRU mode (0): thermal shutdown resets via clock unit — no dedicated GPIO needed.
	 * GPIO mode (1) would require a board-specific thermal shutdown pin.
	 * Polarity 0 = active-low (matches Rockchip reference designs). */
	rockchip,hw-tshut-mode = <0>;
	rockchip,hw-tshut-polarity = <0>;
};

/* combphy1/combphy2: combo PHYs for USB3/SATA/PCIe.
 * Nothing on the Miyoo Flip uses USB3, SATA, or PCIe.
 * WiFi is USB2 (EHCI), and usb_host1_xhci is overridden to USB2-only below.
 * Disabling combphys allows PD_PIPE power domain to gate — saves power. */
&combphy1 {
	status = "disabled";
};

&combphy2 {
	status = "disabled";
};

&usb2phy0_host {
	phy-supply = <&vcc5v0_host>;
	status = "okay";
};

&usb2phy0_otg {
	status = "okay";
};

&usb2phy1_host {
	phy-supply = <&vcc5v0_host>;
	status = "okay";
};

/* usb2phy1_otg: PHY for usb_host0_ehci/ohci (fd800000) which is disabled.
 * No need to power this PHY. Maxwell doesn't define it at all. */
&usb2phy1_otg {
	status = "disabled";
};

&usb2phy0 {
	status = "okay";
};

&usb2phy1 {
	status = "okay";
};

/* usb_host0_ehci/ohci (fd800000/fd840000): USB2 host via usb2phy1_otg.
 * This is a separate USB2 port from the OTG (usb_host0_xhci/usb2phy0_otg)
 * and from the host port where WiFi lives (usb_host1_ehci/usb2phy1_host).
 * Nothing is physically routed to this port on the Miyoo Flip PCB.
 * Disabled to save power — re-enable if a USB device is found on this port. */
&usb_host0_ehci {
	status = "disabled";
};

&usb_host0_ohci {
	status = "disabled";
};

&usb_host1_ehci {
	status = "okay";
};

&usb_host1_ohci {
	status = "okay";
};

/* USB topology:
 *   usb_host0_xhci (fcc00000) = OTG port — peripheral mode (charging/gadget)
 *   usb_host1_xhci (fd000000) = Host port — USB2-only (WiFi chip via EHCI)
 *   usb_host0_ehci/ohci (fd800000) = unused USB2 port — disabled
 *   usb_host1_ehci/ohci (fd880000) = WiFi USB2 host — enabled
 *
 * No USB3 signals are routed on this board; combphy1/2 are disabled.
 * usb_host1_xhci is overridden to USB2-only to avoid DWC3 init failure. */

/* OTG port: peripheral-only mode (charging + USB gadget).
 * Disabling host-side hardware saves power when nothing is plugged in. */
&usb_host0_xhci {
	status = "okay";
	dr_mode = "peripheral";
	phys = <&usb2phy0_otg>;
	phy-names = "usb2-phy";
};

&usb_host1_xhci {
	status = "okay";
	phys = <&usb2phy0_host>;
	phy-names = "usb2-phy";
	maximum-speed = "high-speed";
};

/* VPU (video decoder), VEPU (H.264 encoder), RGA (2D blitter):
 * All use mainline drivers with runtime PM — power domains gate when idle. */
&vpu {
	status = "okay";
};

&vdpu_mmu {
	status = "okay";
};

&vepu {
	status = "okay";
};

&vepu_mmu {
	status = "okay";
};

/* VOP2: display controller. Must be enabled for DRM to bind.
 * Clock parents: DCLK_VOP0 -> HPLL, DCLK_VOP1 -> VPLL. */
&vop {
	status = "okay";
	assigned-clocks = <&cru DCLK_VOP0>, <&cru DCLK_VOP1>;
	assigned-clock-parents = <&pmucru PLL_HPLL>, <&cru PLL_VPLL>;
};

&vop_mmu {
	status = "okay";
};

/* uart1: Miyoo serial protocol for analog stick calibration (9600 8N1). */
&uart1 {
	status = "okay";
	dma-names = "tx", "rx";
	pinctrl-names = "default";
	pinctrl-0 = <&uart1m0_xfer &uart1m0_ctsn>;
};

/* Debug serial at 0xfe660000 (same as earlycon); must be okay for console=ttyS2 */
&uart2 {
	status = "okay";
};

&pinctrl {

	audio-amplifier {
		spk_amp_enable_h: spk-amp-enable-h {
			rockchip,pins =
				<4 RK_PC2 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	headphone {
		hp_det: hp-det {
			rockchip,pins = <4 RK_PC6 RK_FUNC_GPIO &pcfg_pull_down>;
		};
	};

	wireless-wlan {
		wifi_enable_h: wifi-enable-h {
			rockchip,pins =
				<0 RK_PA0 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	pmic {
		pmic_int: pmic_int {
			rockchip,pins =
				<0 RK_PA3 RK_FUNC_GPIO &pcfg_pull_up>;
		};

	};

	usb {
		vcc5v0_host_en: vcc5v0-host-en {
			rockchip,pins = <4 RK_PC5 RK_FUNC_GPIO &pcfg_pull_none>;
		};

	};

	vcc-sd {
		vcc_sd_h: vcc-sd-h {
			rockchip,pins = <0 RK_PA5 RK_FUNC_GPIO &pcfg_pull_down>;
		};
		vcc_sd2_h: vcc-sd2-h {
			rockchip,pins = <2 RK_PB1 RK_FUNC_GPIO &pcfg_pull_down>;
		};		
	};

};
